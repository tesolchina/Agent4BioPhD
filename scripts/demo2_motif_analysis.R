#!/usr/bin/env Rscript
#
# Demo Script: Motif Matching Analysis
# =====================================
# 
# Based on methods from: Badia-i-Mompel et al. (2023)
# Databases mentioned in paper: CIS-BP, ENCODE, HOCOMOCO, JASPAR, TRANSFAC, UniPROBE, cisTarget
# Tools referenced: ArchR, FIMO, GimmeMotifs, HOMER, MOODS, Signac, motifmatchr
#
# This script demonstrates TF motif matching on ATAC-seq peaks
# Generated by: AI Agent
#

library(motifmatchr)
library(GenomicRanges)
library(TFBSTools)
library(BSgenome.Hsapiens.UCSC.hg19)

cat("\n=== Motif Matching Analysis Demo ===\n\n")

# Step 1: Load genomic regions (ATAC-seq peaks)
cat("[1/4] Loading ATAC-seq peaks...\n")
peaks <- GRanges(
  seqnames = c("chr1", "chr1", "chr2", "chr2", "chr3", "chr3", "chr17", "chr17"),
  ranges = IRanges(
    start = c(1000000, 2500000, 1500000, 3000000, 1200000, 2800000, 7571719, 7590856),
    end =   c(1000500, 2500500, 1500500, 3000500, 1200500, 2800500, 7572219, 7591356)
  ),
  peak_id = paste0("peak_", 1:8)
)

cat(paste("  Loaded", length(peaks), "peaks\n"))
cat(paste("  Total genomic space:", sum(width(peaks)), "bp\n\n"))

# Step 2: Load example motifs
# Note: In real analysis, you would load motifs from JASPAR or other databases
# mentioned in the paper
cat("[2/4] Loading TF binding motifs...\n")
data(example_motifs, package = "motifmatchr")
cat(paste("  Loaded", length(example_motifs), "example motifs\n\n"))

# Step 3: Run motif matching
cat("[3/4] Running motif matching analysis...\n")
cat("  This uses the MOODS algorithm mentioned in the paper (Box 1)\n")

motif_matches <- matchMotifs(
  pwms = example_motifs,
  subject = peaks,
  genome = "hg19",
  out = "matches"
)

# Get match matrix
match_matrix <- motifMatches(motif_matches)
cat(paste("  Found matches in", sum(rowSums(match_matrix) > 0), "peaks\n\n"))

# Step 4: Summarize results
cat("[4/4] Generating summary statistics...\n\n")

# Motifs found per peak
motifs_per_peak <- rowSums(match_matrix)
cat("Motifs per peak:\n")
print(summary(motifs_per_peak))

# Peaks per motif
peaks_per_motif <- colSums(match_matrix)
cat("\nPeaks containing each motif:\n")
motif_summary <- data.frame(
  Motif = colnames(match_matrix),
  Peaks = peaks_per_motif,
  Percentage = round(peaks_per_motif / nrow(match_matrix) * 100, 1)
)
motif_summary <- motif_summary[order(-motif_summary$Peaks), ]
print(motif_summary)

# Export results
output_file <- "/workspaces/Agent4BioPhD/outputs/motif_matches.csv"
write.csv(motif_summary, output_file, row.names = FALSE)
cat(paste("\n✓ Results saved to:", output_file, "\n"))

cat("\n=== Analysis Complete! ===\n")
cat("\nKey findings from paper context:\n")
cat("  • TF binding prediction uses motif databases (JASPAR, TRANSFAC, etc.)\n")
cat("  • MOODS algorithm efficiently matches motifs to peaks\n")
cat("  • Combining with gene expression data improves GRN inference\n")
cat("  • See Badia-i-Mompel et al. (2023) Box 1 for detailed methodology\n")
